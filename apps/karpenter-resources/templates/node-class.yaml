apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: {{ .Values.name }}
spec:
  amiFamily: {{ .Values.ec2NodeClass.amiFamily }}
  {{- with .Values.ec2NodeClass.subnetSelectorTerms }}
  subnetSelectorTerms:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.ec2NodeClass.securityGroupSelectorTerms }}
  securityGroupSelectorTerms:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  role: {{ .Values.ec2NodeClass.karpenterRole }}
  tags:
    Name: karpenter-{{ .Values.name }}
  metadataOptions:
    httpEndpoint: {{ .Values.ec2NodeClass.metadataOptions.httpEndpoint }}
    httpProtocolIPv6: {{ .Values.ec2NodeClass.metadataOptions.httpProtocolIPv6 }}
    httpPutResponseHopLimit: {{ .Values.ec2NodeClass.metadataOptions.httpPutResponseHopLimit }}
    httpTokens: {{ .Values.ec2NodeClass.metadataOptions.httpTokens }}
  blockDeviceMappings:
    - deviceName: {{ default "/dev/xvda" .Values.ec2NodeClass.blockDevice.deviceName }}
      ebs:
        volumeSize: {{ .Values.ec2NodeClass.blockDevice.volumeSize }}
        volumeType: {{ .Values.ec2NodeClass.blockDevice.volumeType }}
        encrypted: {{ .Values.ec2NodeClass.blockDevice.encrypted }}
        deleteOnTermination: {{ .Values.ec2NodeClass.blockDevice.deleteOnTermination }}
